<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="ie-comp">
    <title>后台登录 - 科研信息管理系统</title>
    <link rel="stylesheet" href="IMIS/libs/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="IMIS/libs/iconfont/iconfont.css"/>

    <script src="IMIS/libs/jquery-1.11.1.min.js"></script>
    <script src="IMIS/libs/jquery.placeholder.min.js"></script>
    <script src="IMIS/libs/bootstrap/js/bootstrap.min.js"></script>
    <script src="IMIS/js/get_connect/code.js"></script>
    <script src="IMIS/js/get_connect/connect_http.js"></script>
    <script src="IMIS/js/get_connect/return_data.js"></script>

    <script>
        document.write(' <link rel="stylesheet" href="IMIS/css/login.css?time=' + new Date().getTime() + '"/>');

        function loadTopWindow() {
            if (window.top != null && window.top.document.URL != document.URL) {
                window.top.location = document.URL;
            }
        }
    </script>

</head>
<body onload="loadTopWindow()">
<div class="page-login">
    <form class="form-login login" role="form" method="post">
        <h2 class="form-signin-heading">
            <img src="IMIS/images/logo.png"/>
        </h2>
        <div class="form-group">
            <div class="input-box">
                <i class="icon iconfont icon-account2 "></i>
                <input type="text" class="form-control" id="userId" placeholder="用户ID">
            </div>
        </div>
        <div class="form-group">
            <div class="input-box">
                <i class="icon iconfont icon-xiugaimima1"></i>
                <input type="password" class="form-control" id="password" placeholder="密码">
            </div>
        </div>
        <div class="checkbox">
            <label>
                <input type="checkbox" class="remember"> 记住账号
            </label>
            <!--<a class="forget-password" href="#">忘记密码？</a>-->
        </div>
        <div class="login-tip"></div>
        <button type="button" class="btn btn-primary btn-lg btn-block btn-login">登 录</button>
    </form>
</div>
<script>
    $(function () {
        $('input, textarea').placeholder();
        var userId, password;

        if (localStorage.ImisLoginInfo) {
            var loginInfo = JSON.parse(localStorage.ImisLoginInfo);
            $('#userId').val(loginInfo.userId);
            $('#password').val(loginInfo.password);
            $('.remember').attr('checked', true);
        }

        $(window).keydown(function (evt) {
            evt = window.event || evt;
            if (evt.keyCode == 13) {
                var userId = $('#userId').val();
                var password = $('#password').val();
                remember(userId, password);
                login(userId, password);
            }
        });

        $('.btn-login').on("click", function () {
            userId = $('#userId').val();
            password = $('#password').val();
            remember(userId, password);
            login(userId, password);
        });

        $('.remember').on('change', function () {
            if (!this.checked) {
                localStorage.removeItem('ImisLoginInfo');
            }
        });

        function remember(userId, password) {
            if ($('.remember').is(':checked')) {
                var loginInfo = {
                    userId: userId,
                    password: password,
                    dbKey: "string"
                }
                localStorage.ImisLoginInfo = JSON.stringify(loginInfo);
            }
        }

        function login(userId, password) {
            if (userId == '' || password == '') {
                $(".login-tip").html('帐号/密码不能为空！');
            } else {
                var postData = {
                    工号: userId,
                    密码: password,
                    dbKey: 'ScientificResearch_test'
                }
                User.userLogin('post', postData, function userLoginListener(success, obj, strErro) {
                    var tip;
                    $('.login-tip').removeClass('login-tip-success');
                    if (success) {
                        var curTime = new Date().getTime();
                        var url = getHtmlDocName();
                        localStorage.setItem('info', JSON.stringify({data: obj, time: curTime, url: '/' + url + '.html'}));
                        sessionStorage.mUserId = obj.人员.编号;
                        tip = '登录成功！';
                        $('.login-tip').addClass('login-tip-success');
                        $('.login-tip').html(tip);
                        location.href = 'IMIS/views/index.html';
                    } else {
                        tip = '帐号/密码错误！';
                        console.info(strErro);
                    }
                    $('.login-tip').html(tip);
                    setTimeout(function () {
                        $('.login-tip').html('');
                    }, 3000);
                });
            }
        }

        //获取html文件名
        function getHtmlDocName() {
            var str = window.location.href;
            str = str.substring(str.lastIndexOf("/") + 1);
            str = str.substring(0, str.lastIndexOf("."));
            return str;
        }
    });
</script>
</body>
</html>